{{- bos_token }}
{%- if not tools_in_user_message is defined %}
    {%- set tools_in_user_message = true %}
{%- endif %}
{%- if not date_string is defined %}
    {%- set date_string = "26 Jul 2024" %}
{%- endif %}
{%- if not tools is defined %}
    {%- set tools = none %}
{%- endif %}
{#- This block extracts the system message, so we can slot it into the right place. #}
{%- if messages[0]['role'] == 'system' %}
    {%- set system_message = messages[0]['content']|trim %}
    {%- set messages = messages[1:] %}
{%- else %}
    {%- set system_message = "" %}
{%- endif %}

{#- System message + builtin tools #}
{{- "<|start_header_id|>system<|end_header_id|>\n\n" }}
{#{%- if builtin_tools is defined or tools is not none %}
    {{- "Environment: ipython\n" }}
{%- endif %}#}

{{- "Cutting Knowledge Date: December 2023\n" }}
{{- "Today Date: " + (date_string if date_string else '5 Aug 2024') + "\n\n" }}
{%- if tools is not none and not tools_in_user_message %}
    {{- "You have access to the following functions. To call a function, please respond with JSON for a function call." }}
    {{- 'Respond in the format {"name": function name, "parameters": dictionary of argument name and its value}.' }}
    {{- "Do not use variables.\n\n" }}
    {%- for t in tools %}
        {{- t | tojson(indent=4) }}
        {{- "\n\n" }}
    {%- endfor %}

{%- elif tools is not none %}
    {{- "You are a helpful assistant with tool calling capabilities. " }}
    {{- "You will have a list of tools provided to you. When you are asked a question or given " }}
    {{- "an instruction, you may call one of the provided tools to help you give an answer. " }}
    {{- "You may not attempt to call a tool that is not explicitly listed below. " }}
    {{- "When you receive a tool call response, use the output to respond to the original user question or instruction." }}
{%- endif %}
{{- system_message }}
{{- "<|eot_id|>\n" }}

{#- Custom tools are passed in a user message with some extra guidance #}
{%- if tools_in_user_message and not tools is none %}
    {#- Extract the first user message so we can plug it in here #}
    {%- if messages | length != 0 %}
        {%- set first_user_message = messages[0]['content']|trim %}
        {%- set messages = messages[1:] %}
    {%- else %}
        {{- raise_exception("Cannot put tools in the first user message when there's no first user message!") }}
    {%- endif %}
    {{- '<|start_header_id|>user<|end_header_id|>\n\n' -}}
    {{- "Given the following functions, you may respond with a JSON for a function call " }}
    {{- "with its proper arguments that best answers the given prompt. Or, you may answer the user directly without" }}
    {{- " calling a function. If you do not call a function, don't say anything about having functions. " }}
    {{- "When you receive a tool call response, use the output to format an answer to the original user question." }}
    {{- ' If you do call a function, respond in the format {"name": function name, "parameters": dictionary of argument name and its value}.' }}
    {{- " Do not use variables.\n\n" }}
    {%- for t in tools %}
        {{- t | tojson(indent=4) }}
        {{- "\n\n" }}
    {%- endfor %}
    {{- first_user_message + "<|eot_id|>\n" }}
{%- endif %}

{%- for message in messages %}
    {%- if not (message.role == 'ipython' or message.role == 'tool' or 'tool_calls' in message) %}
        {{- '<|start_header_id|>' + message['role'] + '<|end_header_id|>\n\n'+ message['content'] | trim + '<|eot_id|>\n' }}
    {%- elif 'tool_calls' in message %}
        {#- The following blocks assume only 1 tool call. We can fix this ;) #}
        {%- if not message.tool_calls|length == 1 %}
            {{- raise_exception("This model only supports single tool-calls at once!") }}
        {%- endif %}
        {%- set tool_call = message.tool_calls[0].function %}
        {{- '<|start_header_id|>assistant<|end_header_id|>\n\n' -}}
        {{- '{"name": "' + tool_call.name + '", ' }}
        {{- '"parameters": ' }}
        {{- tool_call.arguments }}
        {{- "}" }}

        {{- "<|eot_id|>\n" }}
    {%- elif message.role == "tool" or message.role == "ipython" %}
        {{- "<|start_header_id|>ipython<|end_header_id|>\n\n" }}
        {{- message.content }}
        {{- "<|eot_id|>\n" }}
    {%- endif %}
{%- endfor %}
{%- if add_generation_prompt %}
    {{- '<|start_header_id|>assistant<|end_header_id|>\n\n' }}
{%- endif %}